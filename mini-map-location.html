<div id="location-map-container" style="width:100%;height:230px;border-radius:16px;overflow:hidden;"></div>

<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script src="https://api.mapbox.com/search-js/v1.0.0/web.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>

<script>
  // 1) MAP GLOBALE POUR LA SHEET
  window.locationMap = null;

  // ====== COLLECTIVIT√âS (MINI-CARTE) ======
  window.locationMap_collectivitesData = {
    type: "FeatureCollection",
    features: []
  };

  window.locationMap_collectiviteCodes = new Set();
  window.locationMap_lastCollectivitesBBox = null;
  window.locationMap_lastCollectivitesPad  = 60;

  // ====== RAYON (MODE PAR RAYON) ======
  window.locationMap_radiusCenter = null;
  window.locationMap_radiusKm     = 1;
  window.locationMap_radiusMarker = null;
  window.locationMap_radiusData   = { type: 'FeatureCollection', features: [] };

  function initLocationMap() {
    if (window.locationMap) return;

    const container = document.getElementById('location-map-container');
    if (!container || !window.mapboxgl) {
      setTimeout(initLocationMap, 300);
      return;
    }

    mapboxgl.accessToken = 'pk.eyJ1IjoiaGFkcmllbmxlZ2VyIiwiYSI6ImNtYXBjbDlzYTBncGoyaXNhN3dpajI3b3MifQ.TatwRPDuazMQH2DfSkxv2w';

    window.locationMap = new mapboxgl.Map({
      container: 'location-map-container',
      style: 'mapbox://styles/mapbox/light-v11',
      center: [2.35, 48.86],
      zoom: 10
    });

    console.log('‚úÖ Mini-carte initialis√©e');
  }

  document.addEventListener('DOMContentLoaded', initLocationMap);
  setTimeout(initLocationMap, 500);

  // 2) FONCTIONS EXPOS√âES √Ä BUBBLE

  // a) Afficher les polygones de collectivit√©s
  window.locationMap_showCollectivitePolygons = function (fc) {
    console.log('üìç locationMap_showCollectivitePolygons appel√©e avec', fc);
    
    const map = window.locationMap;
    if (!map) {
      console.warn("üõë locationMap non initialis√©e");
      return;
    }

    if (!map.loaded()) {
      console.log("‚è≥ Carte pas encore charg√©e, attente...");
      map.once('load', function() {
        window.locationMap_showCollectivitePolygons(fc);
      });
      return;
    }

    if (!fc || !fc.features || fc.features.length === 0) {
      console.log("üßπ Aucune collectivit√© √† afficher");
      if (map.getSource("loc-collectivites")) {
        ["loc-collectivites-fill", "loc-collectivites-outline"].forEach(function(id) {
          if (map.getLayer(id)) map.removeLayer(id);
        });
        map.removeSource("loc-collectivites");
      }
      window.locationMap_collectivitesData = { type: "FeatureCollection", features: [] };
      window.locationMap_collectiviteCodes = new Set();
      window.locationMap_lastCollectivitesBBox = null;
      return;
    }

    window.locationMap_collectivitesData = fc;
    window.locationMap_collectiviteCodes = new Set(
      fc.features.map(function(f) { return f.properties.code_insee; })
    );
    
    console.log("üíæ Sauvegarde de", fc.features.length, "collectivit√©s");

    if (map.getSource("loc-collectivites")) {
      map.getSource("loc-collectivites").setData(fc);
      console.log("üîÑ Source mise √† jour");
    } else {
      map.addSource("loc-collectivites", { type: "geojson", data: fc });
      map.addLayer({
        id: "loc-collectivites-fill",
        type: "fill",
        source: "loc-collectivites",
        paint: { "fill-color": "#8A2BE2", "fill-opacity": 0.25 }
      });
      map.addLayer({
        id: "loc-collectivites-outline",
        type: "line",
        source: "loc-collectivites",
        paint: { "line-color": "#8A2BE2", "line-width": 2 }
      });
      console.log("‚ûï Source et layers cr√©√©s");
    }

    try {
      const bbox = turf.bbox(fc);
      window.locationMap_lastCollectivitesBBox = bbox;
      window.locationMap_lastCollectivitesPad = 60;

      console.log("üì¶ BBox calcul√©e:", bbox);
      console.log("üîç map.loaded() =", map.loaded());
      console.log("üîç map.isStyleLoaded() =", map.isStyleLoaded());

      const executeFitBounds = function() {
        try {
          map.fitBounds(bbox, { padding: 60, duration: 600 });
          console.log("‚úÖ fitBounds appliqu√© avec succ√®s");
        } catch (e) {
          console.error("‚ùå Erreur fitBounds:", e);
        }
      };

      setTimeout(executeFitBounds, 100);
    } catch (error) {
      console.error("‚ùå Erreur lors du calcul de bbox:", error);
    }
  };

  // b) Supprimer UNE collectivit√©
  window.locationMap_removeCollectivite = function (code) {
    console.log('üóëÔ∏è Suppression collectivit√©:', code);
    
    const map = window.locationMap;
    if (!map || !map.getSource("loc-collectivites")) return;
    if (!window.locationMap_collectiviteCodes.has(code)) return;

    window.locationMap_collectiviteCodes.delete(code);

    const remainingFeatures = Array.from(window.locationMap_collectiviteCodes)
      .map(function(c) {
        return window.locationMap_collectivitesData.features.find(
          function(f) { return f.properties.code_insee === c; }
        );
      })
      .filter(Boolean);

    const remaining = { type: "FeatureCollection", features: remainingFeatures };

    window.locationMap_collectivitesData = remaining;
    map.getSource("loc-collectivites").setData(remaining);

    if (remaining.features.length) {
      try {
        const bbox = turf.bbox(remaining);
        window.locationMap_lastCollectivitesBBox = bbox;
        
        setTimeout(function() {
          try {
            map.fitBounds(bbox, {
              padding: window.locationMap_lastCollectivitesPad || 60,
              duration: 600
            });
            console.log("‚úÖ Carte ajust√©e apr√®s suppression");
          } catch (e) {
            console.error("‚ùå Erreur fitBounds apr√®s suppression:", e);
          }
        }, 100);
      } catch (error) {
        console.error("‚ùå Erreur calcul bbox apr√®s suppression:", error);
      }
    } else {
      ["loc-collectivites-fill", "loc-collectivites-outline"].forEach(function(id) {
        if (map.getLayer(id)) map.removeLayer(id);
      });
      map.removeSource("loc-collectivites");
      window.locationMap_lastCollectivitesBBox = null;
      console.log("üßπ Derni√®re collectivit√© supprim√©e");
    }
  };

// c) Supprimer TOUTES les collectivit√©s (ex : passage au mode "Par rayon")
window.locationMap_removeAllCollectivites = function () {
  console.log('üßπ locationMap_removeAllCollectivites appel√©e');

  const map = window.locationMap;

  // Vider les structures en m√©moire
  window.locationMap_collectiviteCodes = new Set();
  window.locationMap_collectivitesData = {
    type: "FeatureCollection",
    features: []
  };
  window.locationMap_lastCollectivitesBBox = null;

  // Si la source existe sur la carte, on enl√®ve layers + source
  if (map && map.getSource('loc-collectivites')) {
    ['loc-collectivites-fill', 'loc-collectivites-outline'].forEach((id) => {
      if (map.getLayer(id)) {
        map.removeLayer(id);
        console.log(`‚úÖ Layer ${id} supprim√©`);
      }
    });

    map.removeSource('loc-collectivites');
    console.log('‚úÖ Source loc-collectivites supprim√©e');
  }

  console.log('‚úÖ Toutes les collectivit√©s ont √©t√© supprim√©es de la mini-carte');
};


  // ====== FONCTIONS POUR LE RAYON ======
  
  function drawLocationRadius() {
    console.log("‚û°Ô∏è drawLocationRadius:", { 
      center: window.locationMap_radiusCenter, 
      radiusKm: window.locationMap_radiusKm 
    });

    const map = window.locationMap;
    if (!map || !map.loaded()) {
      console.warn("üõë Carte non charg√©e");
      return;
    }

    if (!window.locationMap_radiusCenter || 
        typeof window.locationMap_radiusCenter.lon !== 'number' || 
        typeof window.locationMap_radiusCenter.lat !== 'number') {
      console.warn("üõë Centre du rayon invalide");
      return;
    }

    if (typeof window.locationMap_radiusKm !== 'number' || window.locationMap_radiusKm <= 0) {
      console.warn("üõë Rayon invalide, 1km par d√©faut");
      window.locationMap_radiusKm = 1;
    }

    let geojson;
    try {
      const circleFeature = turf.circle(
        [window.locationMap_radiusCenter.lon, window.locationMap_radiusCenter.lat], 
        window.locationMap_radiusKm, 
        { steps: 64, units: 'kilometers' }
      );
      geojson = { type: 'FeatureCollection', features: [circleFeature] };
    } catch (error) {
      console.error("üõë Erreur g√©n√©ration cercle:", error);
      return;
    }

    window.locationMap_radiusData = geojson;
    console.log("‚úÖ Donn√©es rayon sauvegard√©es");

    if (map.getSource('loc-radius')) {
      map.getSource('loc-radius').setData(geojson);
      console.log("üîÑ Source rayon mise √† jour");
    } else {
      try {
        map.addSource('loc-radius', { type: 'geojson', data: geojson });
        map.addLayer({
          id: 'loc-radius-fill',
          type: 'fill',
          source: 'loc-radius',
          paint: { 'fill-color': '#8A2BE2', 'fill-opacity': 0.25 }
        });
        map.addLayer({
          id: 'loc-radius-outline',
          type: 'line',
          source: 'loc-radius',
          paint: { 'line-color': '#8A2BE2', 'line-width': 2 }
        });
        console.log("‚ûï Source et layers rayon cr√©√©s");
      } catch (error) {
        console.error("üõë Erreur ajout source/layers rayon:", error);
      }
    }

    try {
      const bbox = turf.bbox(geojson);
      setTimeout(function() {
        map.fitBounds(bbox, { padding: 40, duration: 600 });
        console.log("‚úÖ Carte ajust√©e sur le rayon");
      }, 100);
    } catch (error) {
      console.error("üõë Erreur fitBounds rayon:", error);
    }
  }

  window.locationMap_updateRadius = function(km) {
    console.log("üìç locationMap_updateRadius:", km);
    
    if (typeof km !== 'number' || isNaN(km) || km <= 0) {
      console.warn("üõë Rayon invalide, 1km par d√©faut");
      window.locationMap_radiusKm = 1;
    } else {
      window.locationMap_radiusKm = km;
    }
    
    drawLocationRadius();
  };

  window.locationMap_clearRadius = function() {
    console.log("üßπ locationMap_clearRadius");

    const map = window.locationMap;
    
    // 1. Supprimer le cercle
    if (map && map.getSource('loc-radius')) {
      if (map.getLayer('loc-radius-fill')) map.removeLayer('loc-radius-fill');
      if (map.getLayer('loc-radius-outline')) map.removeLayer('loc-radius-outline');
      map.removeSource('loc-radius');
    }

    // 2. Supprimer le marqueur
    if (window.locationMap_radiusMarker) {
      window.locationMap_radiusMarker.remove();
      window.locationMap_radiusMarker = null;
    }

    // 3. R√©initialiser les variables
    window.locationMap_radiusCenter = null;
    window.locationMap_radiusKm = 1;
    window.locationMap_radiusData = { type: 'FeatureCollection', features: [] };


    // 4. Pr√©venir Bubble que le centre n'existe plus
    if (typeof bubble_fn_radiusCenter === 'function') {
      bubble_fn_radiusCenter({ output1: null, output2: null });
      console.log("üì° bubble_fn_radiusCenter appel√© avec valeurs nulles");
  }

  // 5. Vider le texte de la SearchBox
  const host = document.getElementById('radius-search-container');
  if (host) {
    const input = host.querySelector('input');
    if (input) {
      input.value = '';
      console.log('üßº Champ de recherche vid√©');
    }
  }
  };

  // d) Initialiser la SearchBox
  window.locationMap_initGeocoder = function () {
    const map = window.locationMap;
    if (!map || !window.mapboxsearch) {
      console.log("‚è≥ En attente de mapboxsearch...");
      setTimeout(window.locationMap_initGeocoder, 300);
      return;
    }
    
    const container = document.getElementById('radius-search-container');
    if (!container) {
      console.log("‚è≥ Conteneur radius-search-container introuvable");
      setTimeout(window.locationMap_initGeocoder, 300);
      return;
    }
    
    if (container.dataset.searchboxInit === '1') {
      console.log("‚úÖ SearchBox d√©j√† initialis√©e");
      return;
    }
    container.dataset.searchboxInit = '1';
    
    const sb = new mapboxsearch.MapboxSearchBox();
    sb.accessToken = mapboxgl.accessToken;
    sb.options = {
      types: 'address,poi',
      language: 'fr',
      placeholder: 'Adresse ou lieu‚Ä¶'
    };
    sb.mapboxgl = mapboxgl;
    sb.marker = false;
    sb.bindMap(map);
    
    container.innerHTML = '';
    container.appendChild(sb);
    sb.style.width = '100%';
    
    const showButtons = function() {
      const buttonGroup = document.getElementById('fg_group_rayon');
      if (buttonGroup) {
        buttonGroup.style.visibility = 'visible';
        buttonGroup.style.pointerEvents = 'auto';
        console.log('üëÅÔ∏è Boutons r√©affich√©s');
      }
    };
    
    const hideButtons = function() {
      const buttonGroup = document.getElementById('fg_group_rayon');
      if (buttonGroup) {
        buttonGroup.style.visibility = 'hidden';
        buttonGroup.style.pointerEvents = 'none';
        console.log('üôà Boutons cach√©s');
      }
    };
    
    const observer = new MutationObserver(function() {
      const suggestions = container.querySelector('.suggestions');
      
      if (suggestions && suggestions.children.length > 0) {
        suggestions.style.position = 'absolute';
        suggestions.style.zIndex = '999999';
        suggestions.style.visibility = 'visible';
        suggestions.style.display = 'block';
        suggestions.style.pointerEvents = 'auto';
        
        hideButtons();
      } else {
        showButtons();
      }
    });
    
    observer.observe(container, { childList: true, subtree: true });
    
    sb.addEventListener('retrieve', function(e) {
      const coords = e.detail.features[0].geometry.coordinates;
      const lon = coords[0];
      const lat = coords[1];
      
      console.log('üìç Lieu s√©lectionn√©:', lon, lat);
      
      window.locationMap_radiusCenter = { lon: lon, lat: lat };
      
      if (!window.locationMap_radiusMarker) {
        window.locationMap_radiusMarker = new mapboxgl.Marker({ color: '#8A2BE2' })
          .setLngLat([lon, lat])
          .addTo(map);
        console.log('‚ûï Marqueur cr√©√©');
      } else {
        window.locationMap_radiusMarker.setLngLat([lon, lat]);
        console.log('üîÑ Marqueur d√©plac√©');
      }
      
      if (!window.locationMap_radiusKm || window.locationMap_radiusKm <= 0) {
        window.locationMap_radiusKm = 1;
      }
      drawLocationRadius();
      
      if (typeof bubble_fn_radiusCenter === 'function') {
        bubble_fn_radiusCenter({ output1: lon, output2: lat });
      }
      
      setTimeout(showButtons, 50);
    });
    
    sb.addEventListener('clear', function() {
      console.log('üßπ Recherche effac√©e');
      window.locationMap_clearRadius();
      showButtons();
    });
    
    const input = container.querySelector('input');
    if (input) {
      input.addEventListener('blur', function() {
        setTimeout(function() {
          const suggestions = container.querySelector('.suggestions');
          if (!suggestions || suggestions.children.length === 0) {
            showButtons();
          }
        }, 150);
      });
    }
    
    console.log('‚úÖ SearchBox initialis√©e');
  };
</script>